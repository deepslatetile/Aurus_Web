<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Admin - Aurus</title>
    <style>
        .notification-admin {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: #0D2064;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #1a3185;
        }

        .stats {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<div class="notification-admin">
    <h1>üì® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</h1>

    <div class="stats" id="stats">
        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="test-section">
        <h3>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
        <button onclick="sendTest('personal')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–±–µ —Ç–µ—Å—Ç</button>
        <button onclick="sendTest('broadcast')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º —Ç–µ—Å—Ç</button>
    </div>

    <div class="send-section">
        <h3>üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
        <form id="sendForm">
            <div class="form-group">
                <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                <input type="text" id="title" required>
            </div>
            <div class="form-group">
                <label>–¢–µ–∫—Å—Ç:</label>
                <textarea id="body" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label>–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:</label>
                <select id="target" onchange="toggleTargetId()">
                    <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    <option value="user">–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                    <option value="topic">–¢–µ–º–∞</option>
                </select>
            </div>
            <div class="form-group" id="targetIdGroup" style="display: none;">
                <label id="targetIdLabel">ID:</label>
                <input type="text" id="targetId">
            </div>
            <div class="form-group">
                <label>URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:</label>
                <input type="text" id="url" value="/">
            </div>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
        </form>
    </div>

    <div id="alerts"></div>
</div>

<script>
    function toggleTargetId() {
        const target = document.getElementById('target').value;
        const targetIdGroup = document.getElementById('targetIdGroup');
        const targetIdLabel = document.getElementById('targetIdLabel');

        if (target === 'all') {
            targetIdGroup.style.display = 'none';
        } else {
            targetIdGroup.style.display = 'block';
            targetIdLabel.textContent = target === 'user' ? 'User ID:' : 'Topic:';
        }
    }

    function showAlert(message, type) {
        const alerts = document.getElementById('alerts');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        alert.textContent = message;
        alerts.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }

    async function sendTest(type) {
        try {
            const response = await fetch('/api/push/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({type})
            });

            const result = await response.json();

            if (response.ok) {
                showAlert(result.message, 'success');
            } else {
                showAlert(result.error, 'error');
            }
        } catch (error) {
            showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/push/stats');
            const result = await response.json();

            if (response.ok) {
                const stats = result.stats;
                document.getElementById('stats').innerHTML = `
                        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div>–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫: ${stats.total_subscriptions}</div>
                        <div>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${stats.unique_users}</div>
                        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤: ${stats.active_tokens}</div>
                    `;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    document.getElementById('sendForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            title: document.getElementById('title').value,
            body: document.getElementById('body').value,
            target: document.getElementById('target').value,
            url: document.getElementById('url').value
        };

        const targetId = document.getElementById('targetId').value;
        if (targetId) {
            formData.target_id = targetId;
        }

        try {
            const response = await fetch('/api/push/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                showAlert(`‚úÖ ${result.message} (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${result.sent_count})`, 'success');
                document.getElementById('sendForm').reset();
            } else {
                showAlert(`‚ùå ${result.error}`, 'error');
            }
        } catch (error) {
            showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadStats();
</script>
</body>
</html>